# DNS抓包分析

理论学习DNS原理固然重要，但通过抓包分析真实的DNS数据包，能让我们更直观地理解DNS的工作机制。本节将带你用Wireshark深入观察DNS查询和响应的每一个细节。

## 准备工作

### 工具准备
- **Wireshark**：网络数据包分析工具
- **nslookup或dig**：DNS查询命令行工具
- **浏览器**：用于生成DNS查询

### 清除DNS缓存
在开始抓包前，我们需要清除本地DNS缓存，确保能捕获到完整的DNS查询过程：

**Windows系统：**
```cmd
ipconfig /flushdns
```

**macOS系统：**
```bash
sudo dscacheutil -flushcache
sudo killall -HUP mDNSResponder
```

**Linux系统：**
```bash
sudo systemctl restart systemd-resolved
# 或者
sudo service nscd restart
```

## 基础DNS查询抓包

### 启动抓包
1. 打开Wireshark
2. 选择网络接口（通常是Wi-Fi或有线网卡）
3. 设置过滤器：`dns`
4. 开始捕获

### 执行DNS查询
在命令行中执行：
```bash
nslookup www.baidu.com
```

### 分析DNS查询数据包

让我们详细分析捕获到的DNS查询数据包：

#### DNS查询包结构
```
以太网头部 (14字节)
│
└── IP头部 (20字节)
    │
    └── UDP头部 (8字节)
        │
        └── DNS头部 (12字节)
            │
            └── DNS查询部分 (变长)
```

#### DNS头部分析
```
Transaction ID: 0x1234      # 事务ID，用于匹配查询和响应
Flags: 0x0100              # 标志位
    QR: 0 (Query)          # 0=查询，1=响应
    Opcode: 0 (Standard)   # 操作码，0=标准查询
    AA: 0 (Non-Authoritative) # 权威应答标志
    TC: 0 (Not Truncated)  # 截断标志
    RD: 1 (Recursion Desired) # 期望递归
    RA: 0 (Recursion Not Available) # 递归可用
    Z: 0                   # 保留位
    RCODE: 0 (No Error)    # 响应代码
Questions: 1               # 查询问题数量
Answer RRs: 0             # 回答记录数量
Authority RRs: 0          # 权威记录数量
Additional RRs: 0         # 附加记录数量
```

#### 查询部分分析
```
Name: www.baidu.com       # 查询的域名
Type: A (Host Address)    # 查询类型，A记录
Class: IN (Internet)      # 查询类别，互联网类
```

### 分析DNS响应数据包

DNS响应包的结构与查询包类似，但包含答案：

#### 响应头部
```
Transaction ID: 0x1234    # 与查询包相同的事务ID
Flags: 0x8180            # 响应标志
    QR: 1 (Response)      # 这是响应包
    Opcode: 0 (Standard)  # 标准查询响应
    AA: 0                 # 非权威服务器响应
    TC: 0                 # 未截断
    RD: 1                 # 期望递归
    RA: 1                 # 递归可用
    Z: 0                  # 保留位
    RCODE: 0 (No Error)   # 成功响应
Questions: 1              # 重复查询问题
Answer RRs: 2             # 包含2个答案记录
Authority RRs: 0          # 无权威记录
Additional RRs: 0         # 无附加记录
```

#### 答案部分
```
Name: www.baidu.com
Type: CNAME               # CNAME记录
Class: IN
TTL: 300                  # 缓存时间300秒
Data Length: 15
CNAME: www.a.shifen.com   # 实际指向的域名

Name: www.a.shifen.com
Type: A                   # A记录
Class: IN
TTL: 300
Data Length: 4
Address: 39.156.66.10     # IP地址
```

## 高级DNS抓包分析

### 抓取递归查询过程

要观察完整的递归查询过程，我们需要使用支持迭代查询的工具：

```bash
dig +trace www.baidu.com
```

这个命令会模拟递归解析器的查询过程，我们可以在Wireshark中看到：

1. **查询根域名服务器**
2. **查询.com顶级域名服务器**
3. **查询baidu.com权威域名服务器**

### IPv6 DNS查询

现代网络环境中，IPv6越来越重要。让我们抓取AAAA记录查询：

```bash
nslookup -type=AAAA www.baidu.com
```

在Wireshark中你会看到：
```
Query Type: AAAA (IPv6 Address)
Response: 2400:da00:2::29
```

### MX记录查询

邮件服务器记录查询：
```bash
nslookup -type=MX baidu.com
```

响应包会包含：
```
MX Record:
Priority: 20
Mail Server: mx50.baidu.com
```

## DNS over HTTPS (DoH) 抓包

现代浏览器支持DoH，让我们看看加密DNS的特点：

### 配置DoH
在Firefox中启用DoH：
1. 访问 `about:config`
2. 设置 `network.trr.mode = 2`
3. 设置 `network.trr.uri = https://cloudflare-dns.com/dns-query`

### 抓包观察
启用DoH后，你会发现：
- 传统DNS查询（端口53）消失了
- 出现了大量HTTPS流量（端口443）
- DNS查询被加密在HTTPS数据包中

## 常见DNS问题的抓包诊断

### 问题1：DNS解析失败
**症状：**网站无法访问
**抓包特征：**
```
DNS Query: www.example.com
DNS Response: NXDOMAIN (域名不存在)
```

### 问题2：DNS响应超时
**症状：**网页加载缓慢
**抓包特征：**
```
DNS Query: www.example.com
[等待时间过长]
DNS Query: www.example.com (重试)
```

### 问题3：DNS缓存污染
**症状：**访问到错误的网站
**抓包特征：**
```
DNS Response: www.example.com -> 错误的IP地址
TTL: 86400 (长时间缓存)
```

## 实用过滤器技巧

### Wireshark DNS过滤器
```
# 基础DNS过滤
dns

# 仅查看DNS查询
dns.flags.response == 0

# 仅查看DNS响应
dns.flags.response == 1

# 特定域名查询
dns.qry.name contains "baidu.com"

# 特定查询类型
dns.qry.type == 1    # A记录
dns.qry.type == 28   # AAAA记录
dns.qry.type == 15   # MX记录

# DNS错误响应
dns.flags.rcode != 0

# 大型DNS响应（可能的异常）
dns and udp.length > 512
```

### 组合过滤器
```
# DNS查询和对应的HTTP请求
(dns.qry.name contains "example.com") or (http.host contains "example.com")

# 特定IP的DNS查询
ip.addr == 8.8.8.8 and dns
```

## 性能分析技巧

### DNS延迟分析
在Wireshark中，你可以分析DNS查询的时间：
1. 查找DNS查询包的时间戳
2. 查找对应响应包的时间戳
3. 计算时间差

### 批量DNS查询分析
使用统计功能：
1. 打开 `Statistics -> DNS`
2. 查看查询类型分布
3. 分析响应代码统计

## 安全分析

### 检测DNS隧道
DNS隧道是一种数据泄露技术，特征：
```
# 异常长的子域名
dns.qry.name contains very.long.subdomain.name.example.com

# 异常的查询类型
dns.qry.type == 16  # TXT记录异常多

# 高频查询模式
# 需要统计分析查看
```

### 检测DNS劫持
```
# 检查是否返回意外的IP地址
dns.a == 192.168.1.1  # 检查是否被重定向到本地

# 检查权威性
dns.flags.authoritative == 0  # 非权威响应
```

通过DNS抓包分析，我们不仅能深入理解DNS的工作原理，还能有效诊断网络问题和安全威胁。这是网络工程师和安全专家必备的技能之一。

---

*本文档为《网络101》系列的一部分*
