# 排查方案：用 Wireshark 还原超时现场

下面以“客户端访问 API 超时”为例，给出一套可重复使用的抓包步骤。核心思路是先确认 TCP 层是否完成握手，再沿着时间轴观察请求与响应的流动，最后结合超时点分析原因。

## 1. 同步时间与抓包位置
- 在客户端、服务器分别抓包时，先同步系统时间（使用 NTP），方便对比；
- 客户端超时，多数情况下建议先在客户端侧抓包。如果怀疑服务器处理缓慢，再去服务器端对同一连接抓包对比；
- 确认抓包网卡：无线、VPN、容器内虚拟接口都可能是流量入口。

## 2. 捕获并定位目标连接
1. 开始抓包后重现超时问题。
2. 使用显示过滤器 `tcp.flags.syn == 1 && tcp.port == 443` 找到首次握手。
3. 右键选择“Follow → TCP Stream”，锁定该连接的所有数据包，并在过滤器栏看到 `tcp.stream eq N`。

## 3. 检查握手与 TLS 协商
- 若只看到客户端发送 SYN，未收到 SYN+ACK，则问题可能出现在网络层（防火墙、路由）；
- 如果三次握手完成，但 TLS ClientHello 之后迟迟没有 ServerHello，可能是服务器端或中间层处理慢；
- 使用“统计 → I/O 图表”查看是否存在明显的突发流量或长时间的空窗期。

## 4. 观察请求与响应的时间间隔
- 在 TCP 流窗口中，Wireshark 会展示每个报文的时间戳。记录下应用请求（如 HTTP POST）发出的时间；
- 向下滚动，看看响应报文是否出现、以及耗时多久；
- 如果响应没有出现，但看到 TCP 重传或 Keep-Alive 探测，说明报文可能在链路上丢失；
- 如果响应出现但被延迟送达，结合“统计 → TCP 流图 → Round Trip Time”来判断 RTT 是否异常升高。

## 5. 分析超时触发点
- **客户端主动超时**：抓包中通常能看到客户端发送 `RST` 或 `FIN`，随后报错。这意味着请求等待超过了应用设定的阈值；
- **服务器提前断开**：如果服务器发出 `FIN` 或 `RST`，客户端收到后才报超时，问题就在服务端；
- **中间设备丢包**：观察是否存在 ICMP `Fragmentation Needed`、`Destination Unreachable` 等报文，或在 TTL 递减过程中出现异常节点。

## 6. 记录与共享
- 把过滤后的关键帧导出成 `.pcapng`，命名时包含时间、会话 ID；
- 在分析报告中注明关键时间点：握手、请求、最后一次重传、超时时刻；
- 如需与后端或网络团队协作，可配合 `ss -ntp`、应用日志等信息，形成完整证据链。

只要按照上述步骤逐项排查，就能把“超时”这个模糊的现象拆解成可验证的环节，大幅缩短定位问题的时间。
