# TCP/IP 四层模型的全景图

TCP/IP 协议族常被画成“物理层—链路层—网络层—传输层—应用层”的七层或五层结构，但在工程实践中我们更习惯使用四层模型：网络接口层、网络层、传输层和应用层。与其把它理解成某种“标准答案”，不如把它当成观察网络系统的抽象工具，它告诉我们一个数据包从网卡发出到达应用的过程中都经历了哪些职责分工。

## 网络接口层：把比特送上链路
网络接口层对应 OSI 模型的物理层和数据链路层，它关心的是如何把 0 和 1 放到电缆、光纤或无线电波上。以以太网为例，这一层定义了 MAC 地址的格式、帧头字段、CRC 校验以及 CSMA/CD 介质访问控制算法。驱动程序会负责与网卡硬件协作：

- 根据上层传来的 IP 数据报构造以太网帧，将目的 MAC 地址写入帧头；
- 如果 ARP 缓存中缺乏目标 MAC，就广播 ARP 请求并等待响应；
- 为避免硬件错误导致数据腐化，还要在帧尾添加冗余校验字段。

在这一层中，数据以帧（Frame）为单位传输，最大长度受制于链路类型（例如以太网的 MTU 通常是 1500 字节）。

## 网络层：跨网段的寻址与转发
网络层的代表是 IP 协议。它面向整个互联网，负责为主机分配逻辑地址（IP 地址）并在不同网段之间转发数据包。网络层提供的核心能力包括：

- **路由选择**：通过静态或动态路由协议（如 OSPF、BGP）维护路由表，让数据包找到通往目标网络的最佳路径；
- **分片与重组**：当上层报文超过链路 MTU 时，IP 可以将其拆分成多个片段，抵达目标后再重新组装；
- **协议指示**：IP 头部的协议字段会告诉下一层应该交给 TCP、UDP 还是 ICMP 处理。

网络层的设计是“尽力而为”的——它不保证可靠、按序或无丢失，真正的可靠性交给了传输层处理。

## 传输层：端到端的可靠性与多路复用
传输层解决的是端系统之间的通信问题。它需要在一台机器上同时支持多个应用发包，又要处理网络层“不可靠”的特性。常见协议包括：

- **TCP（Transmission Control Protocol）**：提供可靠、按序、流量控制和拥塞控制的面向连接服务。三次握手建立连接、序列号和确认号保证可靠性、滑动窗口调节发送速率；
- **UDP（User Datagram Protocol）**：轻量级的无连接协议，只有端口号和长度等少量字段，适合实时音视频、DNS 这类对时延敏感或本身具备纠错机制的应用；
- **QUIC**：新兴的传输协议，运行在 UDP 之上，整合了 TLS 加密和多路复用能力，已被广泛用于 HTTP/3。

传输层头部的端口号让多个应用可以共享一个 IP 地址，与此同时还维持着对丢包、乱序、重传等细节的控制。

## 应用层：协议即业务逻辑
应用层是离用户最近的一层，HTTP、DNS、SMTP、SSH 等各种协议都生活在这里。它们直接面向具体业务需求：

- HTTP 定义了浏览器和服务器之间请求—响应的格式；
- DNS 提供域名解析服务，是互联网的“电话簿”；
- SSH 则负责安全地远程登录服务器，提供加密和鉴权。

应用层往往会结合业务场景设计自己的数据编码（JSON、Protobuf）以及状态管理方式。理解这一层的行为，能帮助我们在抓包或排障时精准定位问题究竟出在业务逻辑还是下层网络。

## 数据在四层之间如何流动
TCP/IP 四层模型强调的是“逐层封装与解封装”的思路。发送数据时，应用层把业务数据交给传输层，传输层加上端口号等控制信息形成段（Segment），网络层进一步添加 IP 头部生成数据报（Datagram），最后网络接口层把它封装成帧发送到链路上。接收方按照相反的顺序逐层解析，最终把原始业务数据交给应用处理。

掌握这一套抽象后，你在面对任何网络问题时都能迅速定位到“责任层”，再结合抓包和日志就能逐步逼近根因。
