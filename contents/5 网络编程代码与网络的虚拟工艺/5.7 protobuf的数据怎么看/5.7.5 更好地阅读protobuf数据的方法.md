# æ›´å¥½åœ°é˜…è¯»protobufæ•°æ®çš„æ–¹æ³•

åœ¨å®é™…å¼€å‘å’Œè°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦æŸ¥çœ‹protobufæ•°æ®çš„å†…å®¹ã€‚ç”±äºprotobufæ˜¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œç›´æ¥æŸ¥çœ‹åŸå§‹æ•°æ®å‡ ä¹ä¸å¯èƒ½ç†è§£å…¶å«ä¹‰ã€‚æœ¬ç« å°†ä»‹ç»å¤šç§æœ‰æ•ˆçš„æ–¹æ³•æ¥è¯»å–ã€åˆ†æå’Œè°ƒè¯•protobufæ•°æ®ï¼Œå¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°ç†è§£æ•°æ®ç»“æ„å’Œæ’æŸ¥é—®é¢˜ã€‚

## æ–‡æœ¬æ ¼å¼è¾“å‡º

### 1. ä½¿ç”¨DebugString()æ–¹æ³•

å¤§å¤šæ•°protobufå®ç°éƒ½æä¾›äº†å°†æ¶ˆæ¯è½¬æ¢ä¸ºå¯è¯»æ–‡æœ¬çš„æ–¹æ³•ï¼š

```python
import person_pb2

# åˆ›å»ºä¸€ä¸ªPersonæ¶ˆæ¯
person = person_pb2.Person()
person.name = "å¼ ä¸‰"
person.id = 1234
person.email = "zhangsan@example.com"

# æ·»åŠ ç”µè¯å·ç 
phone = person.phones.add()
phone.number = "13800138000"
phone.type = person_pb2.Person.MOBILE

# è¾“å‡ºä¸ºå¯è¯»æ–‡æœ¬æ ¼å¼
print("=== DebugStringè¾“å‡º ===")
print(person)

# è¾“å‡ºç»“æœï¼š
# name: "å¼ ä¸‰"
# id: 1234
# email: "zhangsan@example.com"
# phones {
#   number: "13800138000"
#   type: MOBILE
# }
```

### 2. JSONæ ¼å¼è½¬æ¢

ç°ä»£protobufåº“æ”¯æŒä¸JSONæ ¼å¼çš„ç›¸äº’è½¬æ¢ï¼š

```python
from google.protobuf.json_format import MessageToJson, Parse
import json

# è½¬æ¢ä¸ºJSONæ ¼å¼
json_string = MessageToJson(person, preserving_proto_field_name=True)
print("=== JSONæ ¼å¼è¾“å‡º ===")
print(json.dumps(json.loads(json_string), indent=2, ensure_ascii=False))

# è¾“å‡ºç»“æœï¼š
# {
#   "name": "å¼ ä¸‰",
#   "id": 1234,
#   "email": "zhangsan@example.com",
#   "phones": [
#     {
#       "number": "13800138000",
#       "type": "MOBILE"
#     }
#   ]
# }

# ä»JSONæ¢å¤protobufæ¶ˆæ¯
json_data = '''
{
  "name": "æå››",
  "id": 5678,
  "email": "lisi@example.com"
}
'''
new_person = person_pb2.Person()
Parse(json_data, new_person)
print(f"ä»JSONæ¢å¤çš„å§“å: {new_person.name}")
```

### 3. è‡ªå®šä¹‰æ ¼å¼åŒ–è¾“å‡º

```python
def format_person_message(person):
    """è‡ªå®šä¹‰æ ¼å¼åŒ–Personæ¶ˆæ¯"""
    lines = []
    lines.append(f"ğŸ‘¤ å§“å: {person.name}")
    lines.append(f"ğŸ†” ID: {person.id}")
    
    if person.email:
        lines.append(f"ğŸ“§ é‚®ç®±: {person.email}")
    
    if person.phones:
        lines.append("ğŸ“ ç”µè¯:")
        for i, phone in enumerate(person.phones, 1):
            type_name = person_pb2.Person.PhoneType.Name(phone.type)
            lines.append(f"   {i}. {phone.number} ({type_name})")
    
    return "\n".join(lines)

# ä½¿ç”¨è‡ªå®šä¹‰æ ¼å¼åŒ–
print("=== è‡ªå®šä¹‰æ ¼å¼åŒ–è¾“å‡º ===")
print(format_person_message(person))

# è¾“å‡ºç»“æœï¼š
# ğŸ‘¤ å§“å: å¼ ä¸‰
# ğŸ†” ID: 1234
# ğŸ“§ é‚®ç®±: zhangsan@example.com
# ğŸ“ ç”µè¯:
#    1. 13800138000 (MOBILE)
```

## äºŒè¿›åˆ¶æ•°æ®åˆ†æ

### 1. åå…­è¿›åˆ¶æŸ¥çœ‹å™¨

```python
def hex_dump(data, bytes_per_line=16):
    """ä»¥åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºäºŒè¿›åˆ¶æ•°æ®"""
    lines = []
    for i in range(0, len(data), bytes_per_line):
        chunk = data[i:i + bytes_per_line]
        
        # åå…­è¿›åˆ¶è¡¨ç¤º
        hex_part = ' '.join(f'{b:02x}' for b in chunk)
        hex_part = hex_part.ljust(bytes_per_line * 3 - 1)
        
        # ASCIIè¡¨ç¤º
        ascii_part = ''.join(chr(b) if 32 <= b <= 126 else '.' for b in chunk)
        
        lines.append(f'{i:08x}: {hex_part} |{ascii_part}|')
    
    return '\n'.join(lines)

# åºåˆ—åŒ–æ¶ˆæ¯å¹¶æŸ¥çœ‹äºŒè¿›åˆ¶æ•°æ®
serialized = person.SerializeToString()
print("=== äºŒè¿›åˆ¶æ•°æ®åå…­è¿›åˆ¶è§†å›¾ ===")
print(hex_dump(serialized))

# è¾“å‡ºç±»ä¼¼ï¼š
# 00000000: 0a 06 e5 bc a0 e4 b8 89 10 d2 09 1a 15 7a 68 |.............zh|
# 00000010: 61 6e 67 73 61 6e 40 65 78 61 6d 70 6c 65 2e |angsan@example.|
# 00000020: 63 6f 6d 22 0f 0a 0b 31 33 38 30 30 31 33 38 |com"...13800138|
# 00000030: 30 30 30 10 01                                  |000..|
```

### 2. å­—æ®µçº§åˆ«è§£æ

```python
def parse_protobuf_fields(data):
    """è§£æprotobufäºŒè¿›åˆ¶æ•°æ®çš„å­—æ®µç»“æ„"""
    fields = []
    offset = 0
    
    while offset < len(data):
        # è¯»å–Tag
        tag_start = offset
        tag = 0
        shift = 0
        
        while True:
            if offset >= len(data):
                break
            byte = data[offset]
            offset += 1
            tag |= (byte & 0x7F) << shift
            if (byte & 0x80) == 0:
                break
            shift += 7
        
        field_number = tag >> 3
        wire_type = tag & 0x07
        
        # æ ¹æ®wire typeè¯»å–å€¼
        if wire_type == 0:  # Varint
            value = 0
            shift = 0
            value_start = offset
            while True:
                if offset >= len(data):
                    break
                byte = data[offset]
                offset += 1
                value |= (byte & 0x7F) << shift
                if (byte & 0x80) == 0:
                    break
                shift += 7
            fields.append({
                'field_number': field_number,
                'wire_type': 'Varint',
                'value': value,
                'raw_bytes': data[tag_start:offset].hex()
            })
            
        elif wire_type == 2:  # Length-delimited
            length = 0
            shift = 0
            length_start = offset
            while True:
                if offset >= len(data):
                    break
                byte = data[offset]
                offset += 1
                length |= (byte & 0x7F) << shift
                if (byte & 0x80) == 0:
                    break
                shift += 7
            
            value_data = data[offset:offset + length]
            offset += length
            
            # å°è¯•è§£æä¸ºå­—ç¬¦ä¸²
            try:
                string_value = value_data.decode('utf-8')
                display_value = f'"{string_value}"'
            except:
                display_value = value_data.hex()
            
            fields.append({
                'field_number': field_number,
                'wire_type': 'Length-delimited',
                'length': length,
                'value': display_value,
                'raw_bytes': data[tag_start:offset].hex()
            })
    
    return fields

# è§£æå­—æ®µç»“æ„
print("=== å­—æ®µçº§åˆ«è§£æ ===")
fields = parse_protobuf_fields(serialized)
for field in fields:
    print(f"å­—æ®µ {field['field_number']}: {field['wire_type']} = {field['value']}")
    print(f"  åŸå§‹å­—èŠ‚: {field['raw_bytes']}")

# è¾“å‡ºç±»ä¼¼ï¼š
# å­—æ®µ 1: Length-delimited = "å¼ ä¸‰"
#   åŸå§‹å­—èŠ‚: 0a06e5bca0e4b889
# å­—æ®µ 2: Varint = 1234
#   åŸå§‹å­—èŠ‚: 10d209
# å­—æ®µ 3: Length-delimited = "zhangsan@example.com"
#   åŸå§‹å­—èŠ‚: 1a157a68616e6773616e406578616d706c652e636f6d
```

## è°ƒè¯•å·¥å…·å’ŒæŠ€å·§

### 1. æ¶ˆæ¯æ¯”è¾ƒå·¥å…·

```python
def compare_messages(msg1, msg2, path=""):
    """æ¯”è¾ƒä¸¤ä¸ªprotobufæ¶ˆæ¯çš„å·®å¼‚"""
    differences = []
    
    # è·å–æ‰€æœ‰å­—æ®µæè¿°ç¬¦
    descriptor = msg1.DESCRIPTOR
    
    for field in descriptor.fields:
        field_name = field.name
        current_path = f"{path}.{field_name}" if path else field_name
        
        # æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
        has_field1 = msg1.HasField(field_name) if field.label != field.LABEL_REPEATED else len(getattr(msg1, field_name)) > 0
        has_field2 = msg2.HasField(field_name) if field.label != field.LABEL_REPEATED else len(getattr(msg2, field_name)) > 0
        
        if has_field1 != has_field2:
            differences.append(f"{current_path}: å­˜åœ¨æ€§ä¸åŒ ({has_field1} vs {has_field2})")
            continue
        
        if not has_field1:
            continue
        
        value1 = getattr(msg1, field_name)
        value2 = getattr(msg2, field_name)
        
        if field.type == field.TYPE_MESSAGE:
            if field.label == field.LABEL_REPEATED:
                # é‡å¤æ¶ˆæ¯å­—æ®µ
                if len(value1) != len(value2):
                    differences.append(f"{current_path}: æ•°ç»„é•¿åº¦ä¸åŒ ({len(value1)} vs {len(value2)})")
                else:
                    for i, (item1, item2) in enumerate(zip(value1, value2)):
                        differences.extend(compare_messages(item1, item2, f"{current_path}[{i}]"))
            else:
                # å•ä¸ªæ¶ˆæ¯å­—æ®µ
                differences.extend(compare_messages(value1, value2, current_path))
        else:
            # åŸºæœ¬ç±»å‹å­—æ®µ
            if value1 != value2:
                differences.append(f"{current_path}: {value1} != {value2}")
    
    return differences

# åˆ›å»ºä¸¤ä¸ªç•¥æœ‰ä¸åŒçš„æ¶ˆæ¯è¿›è¡Œæ¯”è¾ƒ
person1 = person_pb2.Person()
person1.name = "å¼ ä¸‰"
person1.id = 1234
person1.email = "zhangsan@example.com"

person2 = person_pb2.Person()
person2.name = "å¼ ä¸‰"
person2.id = 1235  # ä¸åŒçš„ID
person2.email = "zhangsan@newdomain.com"  # ä¸åŒçš„é‚®ç®±

print("=== æ¶ˆæ¯æ¯”è¾ƒç»“æœ ===")
differences = compare_messages(person1, person2)
for diff in differences:
    print(f"å·®å¼‚: {diff}")
```

### 2. æ¶ˆæ¯éªŒè¯å·¥å…·

```python
def validate_message(message):
    """éªŒè¯protobufæ¶ˆæ¯çš„å®Œæ•´æ€§å’Œåˆç†æ€§"""
    issues = []
    descriptor = message.DESCRIPTOR
    
    for field in descriptor.fields:
        field_name = field.name
        
        # æ£€æŸ¥å¿…éœ€å­—æ®µ
        if field.label == field.LABEL_REQUIRED:
            if not message.HasField(field_name):
                issues.append(f"ç¼ºå°‘å¿…éœ€å­—æ®µ: {field_name}")
        
        # æ£€æŸ¥å­—æ®µå€¼çš„åˆç†æ€§
        if message.HasField(field_name) or (field.label == field.LABEL_REPEATED and len(getattr(message, field_name)) > 0):
            value = getattr(message, field_name)
            
            if field.type == field.TYPE_STRING:
                if field.label == field.LABEL_REPEATED:
                    for i, item in enumerate(value):
                        if not isinstance(item, str):
                            issues.append(f"å­—æ®µ {field_name}[{i}] ä¸æ˜¯å­—ç¬¦ä¸²ç±»å‹")
                        elif len(item.strip()) == 0:
                            issues.append(f"å­—æ®µ {field_name}[{i}] æ˜¯ç©ºå­—ç¬¦ä¸²")
                else:
                    if not isinstance(value, str):
                        issues.append(f"å­—æ®µ {field_name} ä¸æ˜¯å­—ç¬¦ä¸²ç±»å‹")
                    elif len(value.strip()) == 0:
                        issues.append(f"å­—æ®µ {field_name} æ˜¯ç©ºå­—ç¬¦ä¸²")
            
            elif field.type in [field.TYPE_INT32, field.TYPE_INT64]:
                if field.label == field.LABEL_REPEATED:
                    for i, item in enumerate(value):
                        if item < 0:
                            issues.append(f"å­—æ®µ {field_name}[{i}] æ˜¯è´Ÿæ•°: {item}")
                else:
                    if value < 0 and field_name == 'id':  # å‡è®¾IDä¸åº”è¯¥æ˜¯è´Ÿæ•°
                        issues.append(f"å­—æ®µ {field_name} æ˜¯è´Ÿæ•°: {value}")
    
    return issues

# éªŒè¯æ¶ˆæ¯
print("=== æ¶ˆæ¯éªŒè¯ç»“æœ ===")
issues = validate_message(person)
if issues:
    for issue in issues:
        print(f"é—®é¢˜: {issue}")
else:
    print("æ¶ˆæ¯éªŒè¯é€šè¿‡")
```

### 3. æ€§èƒ½åˆ†æå·¥å…·

```python
import time
import sys
from collections import defaultdict

class ProtobufProfiler:
    """protobufæ€§èƒ½åˆ†æå™¨"""
    
    def __init__(self):
        self.stats = defaultdict(list)
        self.memory_stats = defaultdict(list)
    
    def profile_operation(self, operation_name):
        """è£…é¥°å™¨ï¼šåˆ†ææ“ä½œæ€§èƒ½"""
        def decorator(func):
            def wrapper(*args, **kwargs):
                # è®°å½•å¼€å§‹æ—¶é—´å’Œå†…å­˜
                start_time = time.perf_counter()
                start_memory = sys.getsizeof(args[0]) if args else 0
                
                # æ‰§è¡Œæ“ä½œ
                result = func(*args, **kwargs)
                
                # è®°å½•ç»“æŸæ—¶é—´å’Œå†…å­˜
                end_time = time.perf_counter()
                end_memory = sys.getsizeof(result) if result else 0
                
                # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
                self.stats[f"{operation_name}_time"].append(end_time - start_time)
                self.memory_stats[f"{operation_name}_memory"].append(end_memory - start_memory)
                
                return result
            return wrapper
        return decorator
    
    def get_report(self):
        """ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š"""
        report = []
        report.append("=== æ€§èƒ½åˆ†ææŠ¥å‘Š ===")
        
        for operation, times in self.stats.items():
            if times:
                avg_time = sum(times) / len(times)
                min_time = min(times)
                max_time = max(times)
                report.append(f"{operation}:")
                report.append(f"  å¹³å‡æ—¶é—´: {avg_time:.6f}ç§’")
                report.append(f"  æœ€å°æ—¶é—´: {min_time:.6f}ç§’")
                report.append(f"  æœ€å¤§æ—¶é—´: {max_time:.6f}ç§’")
                report.append(f"  æ‰§è¡Œæ¬¡æ•°: {len(times)}")
        
        for operation, memories in self.memory_stats.items():
            if memories:
                avg_memory = sum(memories) / len(memories)
                report.append(f"{operation}:")
                report.append(f"  å¹³å‡å†…å­˜å˜åŒ–: {avg_memory}å­—èŠ‚")
        
        return "\n".join(report)

# ä½¿ç”¨æ€§èƒ½åˆ†æå™¨
profiler = ProtobufProfiler()

@profiler.profile_operation("serialize")
def serialize_message(message):
    return message.SerializeToString()

@profiler.profile_operation("deserialize")
def deserialize_message(data):
    new_message = person_pb2.Person()
    new_message.ParseFromString(data)
    return new_message

# æ‰§è¡Œå¤šæ¬¡æ“ä½œè¿›è¡Œæ€§èƒ½æµ‹è¯•
for _ in range(1000):
    serialized = serialize_message(person)
    deserialized = deserialize_message(serialized)

print(profiler.get_report())
```

## å¯è§†åŒ–å·¥å…·

### 1. æ¶ˆæ¯ç»“æ„å›¾

```python
def generate_message_structure_diagram(message):
    """ç”Ÿæˆæ¶ˆæ¯ç»“æ„çš„Mermaidå›¾è¡¨"""
    lines = ["graph TD"]
    descriptor = message.DESCRIPTOR
    
    # æ ¹èŠ‚ç‚¹
    root_id = f"msg_{descriptor.name}"
    lines.append(f'    {root_id}["{descriptor.name}"]')
    
    field_counter = 0
    for field in descriptor.fields:
        field_counter += 1
        field_id = f"field_{field_counter}"
        
        # å­—æ®µèŠ‚ç‚¹
        field_label = f"{field.name}<br/>({field.type_name})"
        lines.append(f'    {field_id}["{field_label}"]')
        lines.append(f'    {root_id} --> {field_id}')
        
        # å¦‚æœæ˜¯æ¶ˆæ¯ç±»å‹ï¼Œé€’å½’å¤„ç†
        if field.type == field.TYPE_MESSAGE:
            if hasattr(message, field.name):
                field_value = getattr(message, field.name)
                if field.label == field.LABEL_REPEATED:
                    if len(field_value) > 0:
                        for i, item in enumerate(field_value[:3]):  # åªæ˜¾ç¤ºå‰3ä¸ª
                            item_id = f"item_{field_counter}_{i}"
                            lines.append(f'    {item_id}["{field.message_type.name} #{i+1}"]')
                            lines.append(f'    {field_id} --> {item_id}')
                else:
                    if message.HasField(field.name):
                        item_id = f"item_{field_counter}"
                        lines.append(f'    {item_id}["{field.message_type.name}"]')
                        lines.append(f'    {field_id} --> {item_id}')
    
    return "\n".join(lines)

print("=== æ¶ˆæ¯ç»“æ„å›¾ ===")
print("```mermaid")
print(generate_message_structure_diagram(person))
print("```")
```

### 2. æ•°æ®æµè¿½è¸ª

```python
class MessageTracker:
    """æ¶ˆæ¯æ•°æ®æµè¿½è¸ªå™¨"""
    
    def __init__(self):
        self.operations = []
    
    def track_operation(self, operation_type, message, details=""):
        """è®°å½•æ“ä½œ"""
        self.operations.append({
            'timestamp': time.time(),
            'operation': operation_type,
            'message_type': type(message).__name__,
            'message_size': len(message.SerializeToString()),
            'details': details
        })
    
    def generate_timeline(self):
        """ç”Ÿæˆæ“ä½œæ—¶é—´çº¿"""
        if not self.operations:
            return "æ²¡æœ‰è®°å½•çš„æ“ä½œ"
        
        lines = ["```mermaid", "gantt"]
        lines.append("    title æ¶ˆæ¯å¤„ç†æ—¶é—´çº¿")
        lines.append("    dateFormat X")
        lines.append("    axisFormat %L")
        
        start_time = self.operations[0]['timestamp']
        for i, op in enumerate(self.operations):
            relative_time = int((op['timestamp'] - start_time) * 1000)
            lines.append(f"    {op['operation']} :milestone, {relative_time}, 0")
        
        lines.append("```")
        return "\n".join(lines)

# ä½¿ç”¨æ¶ˆæ¯è¿½è¸ªå™¨
tracker = MessageTracker()

# æ¨¡æ‹Ÿä¸€ç³»åˆ—æ“ä½œ
tracker.track_operation("åˆ›å»ºæ¶ˆæ¯", person, "åˆå§‹åŒ–Personå¯¹è±¡")
tracker.track_operation("è®¾ç½®å­—æ®µ", person, "è®¾ç½®name, id, email")
tracker.track_operation("åºåˆ—åŒ–", person, f"å¤§å°: {len(person.SerializeToString())}å­—èŠ‚")

print("=== æ¶ˆæ¯å¤„ç†æ—¶é—´çº¿ ===")
print(tracker.generate_timeline())
```

## æœ€ä½³å®è·µå’Œå»ºè®®

### 1. è°ƒè¯•ç­–ç•¥

```python
def debug_protobuf_issue(message, expected_fields=None):
    """protobufé—®é¢˜è°ƒè¯•åŠ©æ‰‹"""
    print("=== Protobufè°ƒè¯•ä¿¡æ¯ ===")
    
    # 1. åŸºæœ¬ä¿¡æ¯
    print(f"æ¶ˆæ¯ç±»å‹: {type(message).__name__}")
    print(f"åºåˆ—åŒ–å¤§å°: {len(message.SerializeToString())}å­—èŠ‚")
    
    # 2. å­—æ®µæ£€æŸ¥
    descriptor = message.DESCRIPTOR
    print(f"\nå­—æ®µçŠ¶æ€:")
    for field in descriptor.fields:
        field_name = field.name
        has_field = message.HasField(field_name) if field.label != field.LABEL_REPEATED else len(getattr(message, field_name)) > 0
        
        if has_field:
            value = getattr(message, field_name)
            if field.label == field.LABEL_REPEATED:
                print(f"  âœ“ {field_name}: {len(value)}ä¸ªå…ƒç´ ")
            else:
                print(f"  âœ“ {field_name}: {value}")
        else:
            print(f"  âœ— {field_name}: æœªè®¾ç½®")
    
    # 3. æœŸæœ›å­—æ®µæ£€æŸ¥
    if expected_fields:
        print(f"\næœŸæœ›å­—æ®µæ£€æŸ¥:")
        for field_name in expected_fields:
            if hasattr(message, field_name):
                has_field = message.HasField(field_name) if field_name in [f.name for f in descriptor.fields if f.label != f.LABEL_REPEATED] else len(getattr(message, field_name)) > 0
                status = "âœ“" if has_field else "âœ—"
                print(f"  {status} {field_name}")
            else:
                print(f"  âš  {field_name}: å­—æ®µä¸å­˜åœ¨")
    
    # 4. åºåˆ—åŒ–æµ‹è¯•
    try:
        serialized = message.SerializeToString()
        new_message = type(message)()
        new_message.ParseFromString(serialized)
        print(f"\nåºåˆ—åŒ–æµ‹è¯•: âœ“ æˆåŠŸ")
    except Exception as e:
        print(f"\nåºåˆ—åŒ–æµ‹è¯•: âœ— å¤±è´¥ - {e}")

# ä½¿ç”¨è°ƒè¯•åŠ©æ‰‹
debug_protobuf_issue(person, expected_fields=['name', 'id', 'email', 'phones'])
```

### 2. æ•°æ®éªŒè¯æ¨¡å¼

```python
def create_validation_schema(message_class):
    """ä¸ºprotobufæ¶ˆæ¯åˆ›å»ºéªŒè¯æ¨¡å¼"""
    descriptor = message_class.DESCRIPTOR
    schema = {
        'message_type': descriptor.name,
        'fields': {}
    }
    
    for field in descriptor.fields:
        field_info = {
            'type': field.type_name,
            'required': field.label == field.LABEL_REQUIRED,
            'repeated': field.label == field.LABEL_REPEATED,
            'number': field.number
        }
        
        # æ·»åŠ ç±»å‹ç‰¹å®šçš„éªŒè¯è§„åˆ™
        if field.type == field.TYPE_STRING:
            field_info['validators'] = ['non_empty', 'valid_utf8']
        elif field.type in [field.TYPE_INT32, field.TYPE_INT64]:
            field_info['validators'] = ['positive'] if field.name == 'id' else []
        
        schema['fields'][field.name] = field_info
    
    return schema

# ç”ŸæˆéªŒè¯æ¨¡å¼
schema = create_validation_schema(person_pb2.Person)
print("=== éªŒè¯æ¨¡å¼ ===")
import json
print(json.dumps(schema, indent=2, ensure_ascii=False))
```

## æ€»ç»“

æœ‰æ•ˆåœ°é˜…è¯»å’Œè°ƒè¯•protobufæ•°æ®éœ€è¦æŒæ¡å¤šç§å·¥å…·å’ŒæŠ€å·§ï¼š

### åŸºç¡€æ–¹æ³•
- **æ–‡æœ¬æ ¼å¼è¾“å‡º**ï¼šä½¿ç”¨DebugString()å’ŒJSONè½¬æ¢
- **äºŒè¿›åˆ¶åˆ†æ**ï¼šåå…­è¿›åˆ¶æŸ¥çœ‹å’Œå­—æ®µçº§è§£æ
- **è‡ªå®šä¹‰æ ¼å¼åŒ–**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šåˆ¶è¾“å‡ºæ ¼å¼

### é«˜çº§å·¥å…·
- **æ¶ˆæ¯æ¯”è¾ƒ**ï¼šå¿«é€Ÿå‘ç°æ•°æ®å·®å¼‚
- **æ€§èƒ½åˆ†æ**ï¼šç›‘æ§åºåˆ—åŒ–/ååºåˆ—åŒ–æ€§èƒ½
- **ç»“æ„å¯è§†åŒ–**ï¼šç”Ÿæˆæ¶ˆæ¯ç»“æ„å›¾è¡¨

### è°ƒè¯•ç­–ç•¥
- **ç³»ç»ŸåŒ–éªŒè¯**ï¼šå»ºç«‹å®Œæ•´çš„éªŒè¯æµç¨‹
- **é—®é¢˜è¿½è¸ª**ï¼šè®°å½•å’Œåˆ†ææ•°æ®æµ
- **æœ€ä½³å®è·µ**ï¼šéµå¾ªè°ƒè¯•å’ŒéªŒè¯è§„èŒƒ

æŒæ¡è¿™äº›æ–¹æ³•å’Œå·¥å…·ï¼Œèƒ½å¤Ÿå¤§å¤§æé«˜protobufæ•°æ®çš„å¯è¯»æ€§å’Œè°ƒè¯•æ•ˆç‡ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£å’Œç»´æŠ¤åŸºäºprotobufçš„ç³»ç»Ÿã€‚

---

*æœ¬æ–‡æ¡£ä¸ºã€Šç½‘ç»œ101ã€‹ç³»åˆ—çš„ä¸€éƒ¨åˆ†*